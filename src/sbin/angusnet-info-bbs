#!/usr/bin/env perl

# this is intended to be run through in.telnetd as a replacement
# for login with telnetd running as nobody, example inetd.conf:
# telnet stream tcp nowait nobody /usr/sbin/tcpd /usr/sbin/in.telnetd -L /usr/local/sbin/angusnet-info-bbs

# debian packages:
#   cowsay bsdgames animals libfile-slurp-perl telnetd libyaml-perl

use strict;
use warnings;
use v5.10;
use autodie;

use Data::Dumper;
use File::Basename;
use Getopt::Long;

main();

sub main {
    # ignored for now - just here for compat with in.telnetd
    my %args = parse_args();
    my $bbs = BBS->new;

    $bbs->run_session;
    exit(0);
}

sub parse_args {
    my %args;

    GetOptions(
        "p" => \$args{preserve},
        "h=s" => \$args{host},
    ) or usage();

    usage() if @ARGV;

    return %args;
}

sub usage {
    my $basename = basename($0);

    say STDERR "Usage:";
    say STDERR "  $basename [-p] [-h <hostname>] <username>";
    say STDERR "  like /usr/bin/login but all switches are ignored";
    say STDERR "  specifying a username generates a fatal error";

    exit(1);
}

package BBS;

use strict;
use warnings;
use v5.10;
use autodie;

use Data::Dumper;
use File::Slurp;
use YAML qw(LoadFile);

use constant VERSION => '0.0.1';
use constant INFO_PATH => '/etc/local/angusnet/nodeinfo.txt';
use constant CONFIG_PATH => '/etc/local/angusnet/angusnet-info-bbs.yaml';
use constant PROMPT => '? for help> ';

use constant COMMAND_HANDLERS => {
    '?' => \&command_help,
    help => \&command_help,
    bye => \&command_bye,
    exit => \&command_bye,
    quit => \&command_bye,
    logout => \&command_bye,
    info => \&command_info,
    cow => \&command_cow,
};

use constant COW_PROGRAMS => {
    say => '/usr/games/cowsay',
    think => '/usr/games/cowthink',
};

sub new {
    my ($package) = @_;
    return bless({}, $package);
}

sub run_session {
    my ($self) = @_;
    our $CONFIG = load_config(CONFIG_PATH);
    my $handlers = make_handlers();
    our $SESSION_RUNNING = 1;
    our $VERSION;

    # more puts less load on the network
    $ENV{PAGER} = "more";

    say "AngusBBS v", VERSION;
    say "Enable linemode in your telnet client for best experience.";

    while($SESSION_RUNNING) {
        my (@input) = prompt();

        # user pushed enter and had nothing but white space
        next unless @input;
        my ($command, @args) = @input;
        # read error
        last unless defined $command;

        my $handler = $handlers->{$command};
        if (defined $handler) {
            $handler->(@args);
        } else {
            bad_command($command);
        }
    }
}

sub load_config {
    my ($path) = @_;
    return LoadFile($path);
}

sub make_handlers {
    my ($config) = @_;
    our $CONFIG;
    my $menu = $CONFIG->{menu};
    my %handlers = COMMAND_HANDLERS->%*;

    foreach my $menu_name (keys %$menu) {
        die "duplicate menu name: $menu_name" if exists $handlers{$menu_name};
        $handlers{$menu_name} = sub { dynamic_command($menu->{$menu_name}, @_) };
    }

    return \%handlers;
}

sub prompt {
    our $SESSION_RUNNING = 1;

    print PROMPT;

    my $input = <STDIN>;
    return undef unless defined $input;

    $input =~ s/^\s+//;
    $input =~ s/\s+$//;

    return split(/\s+/, $input);
}

sub bad_command {
    my ($command) = @_;
    say "Error: invalid command '$command'";
    say '';
}

sub command_help {
    our $CONFIG;

    say "Commands:";
    say "  ? or help: Get this help info";
    say "  bye: logout";
    say "  info: get a text description of this system";

    foreach my $menu_name (sort keys $CONFIG->{menu}->%*) {
        say "  $menu_name: ", $CONFIG->{menu}->{$menu_name}->{messages}->{help};
    }

    say '';
}

sub command_bye {
    our $SESSION_RUNNING = 0;
    say "Logging out";
}

sub command_info {
    if (-e INFO_PATH) {
        say read_file(INFO_PATH);
    } else {
        say "no info available";
    }
}

sub show_program {
    my (@command) = @_;
    system(@command);
    say '';
    return;
}

sub command_cow {
    my (@args) = @_;

    if (@args < 2) {
        command_cow__usage();
        return;
    };

    my $verb = shift @args;
    my $text = join(' ', @args);
    my $program = COW_PROGRAMS->{$verb};

    if (defined $program) {
        system($program, $text);
    } else {
        command_cow__usage();
    }

}

sub command_cow__usage {
    say "Usage: ";
    say "  cow say <something to say>";
    say "  cow think <something to think>";

    return;
}

sub dynamic_command {
    my ($menu, @args) = @_;

    if (@args != 1) {
        dynamic_command__usage($menu);
        return;
    }

    my $menu_item = $args[0];
    my $program = $menu->{programs}->{$menu_item};

    if (defined $program) {
        show_program($program);
    } else {
        say "Error: invalid argument '$menu_item'";
        dynamic_command__usage($menu);
    }
}

sub dynamic_command__usage {
    my ($menu) = @_;

    say "Usage: ", $menu->{messages}->{usage};
    say $menu->{messages}->{list};

    foreach my $name (sort keys $menu->{programs}->%*) {
        say "  ", $name;
    }
}
